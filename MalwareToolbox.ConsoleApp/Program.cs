using CommandLine;
using MalwareToolbox.ConsoleApp;
using MalwareToolbox.LibraryC.Executables;
using MalwareToolbox.LibraryC.Hashing;
using MalwareToolbox.LibraryC.Unpackers;
using MalwareToolbox.LibraryC.RegShot;
using MalwareToolbox.LibraryC.Strings;

// var packerDb = new PackerDatabase(@"C:\Users\wben1\Downloads\userdb.txt");
//
// if (!packerDb.Load())
// {
//     Console.WriteLine("Failed to load packer database");
// }
//
// foreach (var packer in packerDb.GetSignatures())
// {
//     Console.WriteLine(packer.SignatureValues);
// }
//
// packerDb.GetSignatures()[0].SignatureValues.ToList().ForEach(x => Console.WriteLine("{0:X}", x));

// var regshot = new RegShot();
// RegistryKey snapshot_1 = regshot.TakeSnapshot();
// Console.WriteLine("Snapshot 1 taken");
//
// string empty = Console.ReadLine();
//
// RegistryKey snapshot_2 = regshot.TakeSnapshot();
// Console.WriteLine("Snapshot 2 taken");
//
// regshot.CompareSnapshots(snapshot_1, snapshot_2);

// var data = key.SubKeys["test"];
// foreach (var value in data.Values.Values)
// {
//     Console.WriteLine(value.Name);
//     Console.WriteLine(value.Data);
//     Console.WriteLine("");
// }    

Parser.Default.ParseArguments<Commands.Regshot, Commands.Strings, Commands.PeInfo, Commands.PackerId, Commands.Hash>(args)
    .WithParsed<Commands.Regshot>(RegshotRun)
    .WithParsed<Commands.Strings>(StringsRun)
    .WithParsed<Commands.PeInfo>(PeInfoRun)
    .WithParsed<Commands.PackerId>(PackerIdRun)
    .WithParsed<Commands.Hash>(HashRun);

void RegshotRun(Commands.Regshot opts)
{
    var regshot = new RegShot();
    
    Console.WriteLine("Taking Snapshot 1...");
    RegistryKey snapshot_1 = regshot.TakeSnapshot();
    Console.WriteLine("Snapshot 1 taken");
    Console.WriteLine("");

    Console.WriteLine("Press any key to take snapshot 2...");
    Console.Read();

    Console.WriteLine("Taking Snapshot 2...");
    RegistryKey snapshot_2 = regshot.TakeSnapshot();
    Console.WriteLine("Snapshot 2 taken");
    Console.WriteLine("");
    
    RegistryKeysDiff keysDiff = regshot.CompareSnapshots(snapshot_1, snapshot_2);

    Console.WriteLine("----Differences----");

    Console.ForegroundColor = ConsoleColor.Black;
    Console.BackgroundColor = ConsoleColor.DarkGreen;
    keysDiff.RegistryKeyAdded.ForEach(x => Console.WriteLine(" + [{0}]\n", x.FullPath));
    Console.ResetColor();

    Console.ForegroundColor = ConsoleColor.Black;
    Console.BackgroundColor = ConsoleColor.DarkRed;
    keysDiff.RegistryKeyRemoved.ForEach(x => Console.WriteLine(" - [{0}]\n", x.FullPath));
    Console.ResetColor();
    
    foreach (var registryValuesDiff in keysDiff.RegistryKeyModified)
    {
        Console.ForegroundColor = ConsoleColor.Black;
        Console.BackgroundColor = ConsoleColor.DarkYellow;
        Console.WriteLine(" ~ [{0}]", registryValuesDiff.Key.FullPath);
        Console.ResetColor();

        registryValuesDiff.Value.RegistryValueAdded.ForEach(x =>
        {
            Console.ResetColor();
            Console.Write("    ");
            
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Green;
            Console.WriteLine(" + {0}: {1}", x.Name, x.Data);
        });

        registryValuesDiff.Value.RegistryValueRemoved.ForEach(x =>
        {
            Console.ResetColor();
            Console.Write("    ");
            
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Red;
            Console.WriteLine(" - {0}: {1}", x.Name, x.Data);
        });

        registryValuesDiff.Value.RegistryValueModified.ForEach(x =>
        {
            Console.ResetColor();
            Console.Write("    ");
            
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Yellow;
            Console.Write(" ~ {0}: ", x.Old.Name);

            Console.ResetColor();
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Red;
            Console.Write("{0}", x.Old);

            Console.ResetColor();
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Yellow;
            Console.Write(" -> ");

            Console.ResetColor();
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Green;
            Console.Write("{0}", x.New);

            Console.ResetColor();
            Console.ForegroundColor = ConsoleColor.Black;
            Console.BackgroundColor = ConsoleColor.Yellow;
            Console.Write(" ");

            Console.ResetColor();
            Console.BackgroundColor = ConsoleColor.Black;
            Console.WriteLine("");
        });

        Console.ResetColor();
        Console.BackgroundColor = ConsoleColor.Black;
        Console.WriteLine("");
    }

    Console.ResetColor();
}    

void StringsRun(Commands.Strings opts)
{
    var file = new MalwareToolbox.LibraryC.Utils.File(opts.File);
    if (!file.Load())
    {
        Console.WriteLine("Failed to load file");
        return;
    }

    StringAnalyser strings = new StringAnalyser(file);
    List<String> result = strings.GenerateStrings(opts.Min, opts.Max);

    StringCategoriser categoriser = new StringCategoriser();
    var catergoriseStrings = categoriser.CatergoriseStrings(result);

    foreach (var catergoriseString in catergoriseStrings)
    {
        Console.WriteLine("{0} : {1}", catergoriseString.Item2, catergoriseString.Item1);
    }
}

void PeInfoRun(Commands.PeInfo opts)
{
    var pe = new PE(opts.File);
    if (!pe.Load())
    {
        Console.WriteLine("Failed to load file");
        return;
    }

    PrintPe(pe);
}

void PackerIdRun(Commands.PackerId opts)
{
    var packerDb = new PackerDatabase(opts.Database);
    if (!packerDb.Load())
    {
        Console.WriteLine("Failed to load packer database");
    }

    var pe = new PE(opts.File);
    if (!pe.Load())
    {
        Console.WriteLine("Failed to load file");
        return;
    }

    PrintPe(pe);
    
    List<Signature> signatures = packerDb.ScanPE(pe, ScanMode.EpOnly);
    foreach (var signature in signatures)
    {
        Console.WriteLine(signature.Tool);
    }
}

void HashRun(Commands.Hash opts)
{
    var pe = new PE(opts.File);
    if (!pe.Load())
    {
        Console.WriteLine("Failed to load file");
        return;
    }

    IHasher hasher;
    switch (opts.Type)
    {
        case "sha256":
            hasher = new Sha256Hasher(pe);
            break;
        case "md5":
            hasher = new Md5Hasher(pe);
            break;
        default:
            Console.WriteLine("Unknown hash type");
            return;
    }
    
    Console.WriteLine(Convert.ToHexString(hasher.Hash()));
}

void PrintPe(PE pe)
{
    Console.WriteLine("----File Properties----");
    Console.WriteLine("Path: {0}", pe.Path);
    Console.WriteLine("Size: {0}", pe.Size);
    Console.WriteLine("Is DLL: {0}", pe.IsDLL());
    Console.WriteLine("Is 64 bit: {0}", pe.Is64Bit());
    Console.WriteLine("");
    Console.WriteLine("----DOS Headers----");
    Console.WriteLine("Magic: {0:X}", pe.DosHeaders.Magic);
    Console.WriteLine("Lfanew: {0:X}", pe.DosHeaders.Lfanew);
    Console.WriteLine("");
    Console.WriteLine("----NT File Headers----");
    Console.WriteLine("Signature: {0:X}", pe.NtFileHeaders.Signature);
    Console.WriteLine("Machine: {0:X}", pe.NtFileHeaders.Machine);
    Console.WriteLine("NumberOfSections: {0:D}", pe.NtFileHeaders.NumberOfSections);
    Console.WriteLine("TimeDateStamp: {0:X}", pe.NtFileHeaders.TimeDateStamp);
    Console.WriteLine("PointerToSymbolTable: {0:X}", pe.NtFileHeaders.PointerToSymbolTable);
    Console.WriteLine("NumberOfSymbols: {0:D}", pe.NtFileHeaders.NumberOfSymbols);
    Console.WriteLine("SizeOfOptionalHeader: {0:D}", pe.NtFileHeaders.SizeOfOptionalHeader);
    Console.WriteLine("Characteristics: {0:X}", pe.NtFileHeaders.Characteristics);
    Console.WriteLine("----NT Optional Headers----");
    Console.WriteLine("Magic: {0:X}", pe.NtOptionalHeaders.Magic);
    Console.WriteLine("MajorLinkerVersion: {0:D}", pe.NtOptionalHeaders.MajorLinkerVersion);
    Console.WriteLine("MinorLinkerVersion: {0:D}", pe.NtOptionalHeaders.MinorLinkerVersion);
    Console.WriteLine("SizeOfCode: {0:D}", pe.NtOptionalHeaders.SizeOfCode);
    Console.WriteLine("SizeOfInitializedData: {0:D}", pe.NtOptionalHeaders.SizeOfInitializedData);
    Console.WriteLine("SizeOfUninitializedData: {0:D}", pe.NtOptionalHeaders.SizeOfUninitializedData);
    Console.WriteLine("AddressOfEntryPoint: {0:X}", pe.NtOptionalHeaders.AddressOfEntryPoint);
    Console.WriteLine("BaseOfCode: {0:X}", pe.NtOptionalHeaders.BaseOfCode);
    Console.WriteLine("SectionAlignment: {0:D}", pe.NtOptionalHeaders.SectionAlignment);
    Console.WriteLine("FileAlignment: {0:D}", pe.NtOptionalHeaders.FileAlignment);
    Console.WriteLine("MajorOperatingSystemVersion: {0:D}", pe.NtOptionalHeaders.MajorOperatingSystemVersion);
    Console.WriteLine("MinorOperatingSystemVersion: {0:D}", pe.NtOptionalHeaders.MinorOperatingSystemVersion);
    Console.WriteLine("MajorImageVersion: {0:D}", pe.NtOptionalHeaders.MajorImageVersion);
    Console.WriteLine("MinorImageVersion: {0:D}", pe.NtOptionalHeaders.MinorImageVersion);
    Console.WriteLine("MajorSubsystemVersion: {0:D}", pe.NtOptionalHeaders.MajorSubsystemVersion);
    Console.WriteLine("MinorSubsystemVersion: {0:D}", pe.NtOptionalHeaders.MinorSubsystemVersion);
    Console.WriteLine("Win32VersionValue: {0:X}", pe.NtOptionalHeaders.Win32VersionValue);
    Console.WriteLine("SizeOfImage: {0:D}", pe.NtOptionalHeaders.SizeOfImage);
    Console.WriteLine("SizeOfHeaders: {0:D}", pe.NtOptionalHeaders.SizeOfHeaders);
    Console.WriteLine("CheckSum: {0:X}", pe.NtOptionalHeaders.CheckSum);
    Console.WriteLine("Subsystem: {0:D}", pe.NtOptionalHeaders.Subsystem);
    Console.WriteLine("DllCharacteristics: {0:D}", pe.NtOptionalHeaders.DllCharacteristics);
    Console.WriteLine("LoaderFlags: {0:X}", pe.NtOptionalHeaders.LoaderFlags);
    Console.WriteLine("NumberOfRvaAndSizes: {0:D}", pe.NtOptionalHeaders.NumberOfRvaAndSizes);
    Console.WriteLine("");
    if (pe.Is64Bit())
    {
        NtOptionalHeader64 ntOptionalHeaders = (pe.NtOptionalHeaders as NtOptionalHeader64)!;
        Console.WriteLine("ImageBase: {0:X}", ntOptionalHeaders.ImageBase);
        Console.WriteLine("SizeOfStackReserve: {0:X}", ntOptionalHeaders.SizeOfStackReserve);
        Console.WriteLine("SizeOfStackCommit: {0:X}", ntOptionalHeaders.SizeOfStackCommit);
        Console.WriteLine("SizeOfHeapReserve: {0:X}", ntOptionalHeaders.SizeOfHeapReserve);
        Console.WriteLine("SizeOfHeapCommit: {0:X}", ntOptionalHeaders.SizeOfHeapCommit);        
    }
    else
    {
        NtOptionalHeader32 ntOptionalHeaders = (pe.NtOptionalHeaders as NtOptionalHeader32)!;
        Console.WriteLine("BaseOfData: {0:X}", ntOptionalHeaders.BaseOfData);
        Console.WriteLine("ImageBase: {0:X}", ntOptionalHeaders.ImageBase);
        Console.WriteLine("SizeOfStackReserve: {0:X}", ntOptionalHeaders.SizeOfStackReserve);
        Console.WriteLine("SizeOfStackCommit: {0:X}", ntOptionalHeaders.SizeOfStackCommit);
        Console.WriteLine("SizeOfHeapReserve: {0:X}", ntOptionalHeaders.SizeOfHeapReserve);
        Console.WriteLine("SizeOfHeapCommit: {0:X}", ntOptionalHeaders.SizeOfHeapCommit);
    }
    Console.WriteLine("");
    foreach (var section in pe.SectionHeaders)
    {
        Console.WriteLine("----Section Header----");
        Console.WriteLine("Name: {0}", section.Name);
        Console.WriteLine("VirtualSize: {0:D}", section.VirtualSize);
        Console.WriteLine("VirtualAddress: {0:X}", section.VirtualAddress);
        Console.WriteLine("SizeOfRawData: {0:D}", section.SizeOfRawData);
        Console.WriteLine("PointerToRawData: {0:X}", section.PointerToRawData);
        Console.WriteLine("");
    }
}
