using MalwareToolbox.Library.VirusTotalAPI;
using MalwareToolbox.Library.DNSReqCapture;
using MalwareToolbox.LibraryC.Executables;
using MalwareToolbox.LibraryC.Hashing;
using MalwareToolbox.LibraryC.Unpackers;
using MalwareToolbox.LibraryC.RegShot;
using MalwareToolbox.LibraryC.Strings;
using MalwareToolbox.LibraryC.Utils;
using static MalwareToolbox.ConsoleApp.Commands;
using static MalwareToolbox.ConsoleApp.PrettyPrint;

namespace MalwareToolbox.ConsoleApp;

public class Runners
{
    static void HashRun(Hash opts)
    {
        var file = new WinFile(opts.File);
        if (!file.Load())
        {
            Console.WriteLine("Failed to load file");
            return;
        }

        IHasher hasher = opts.Type switch
        {
            "sha256" => new Sha256Hasher(file),
            "md5" => new Md5Hasher(file),
            _ => throw new Exception($"Invalid hash type: {opts.Type}"),
        };

        Console.WriteLine(Convert.ToHexString(hasher.Hash()));
    }

    static void PeInfoRun(Commands.PeInfo opts)
    {
        var file = new WinFile(opts.File);
        if (!file.Load())
        {
            Console.WriteLine("Failed to load file");
            return;
        }
        
        var pe = new PE(file);
        if (!pe.LoadHeaders())
        {
            Console.WriteLine("Failed to load PE");
            return;
        }

        PrintPe(pe);
    }

    static void PeidRun(Peid opts)
    {
        var packerDb = new PackerDatabase(opts.Database);
        if (!packerDb.Load())
        {
            Console.WriteLine("Failed to load packer database");
        }

        var file = new WinFile(opts.File);
        if (!file.Load())
        {
            Console.WriteLine("Failed to load file");
            return;
        }
        
        var pe = new PE(file);
        if (!pe.LoadHeaders())
        {
            Console.WriteLine("Failed to load PE");
            return;
        }

        List<Signature> signatures = packerDb.ScanPE(pe, ScanMode.EpOnly);
        foreach (var signature in signatures)
        {
            Console.WriteLine(signature.Tool);
        }
    }

    static void RegshotRun(Regshot opts)
    {
        var regshot = new RegShot();

        Console.WriteLine("Taking Snapshot 1...");
        RegistryHive snapshot_1 = regshot.TakeSnapshot(RegistryHiveType.HkeyCurrentUser);
        Console.WriteLine("Snapshot 1 taken");
        Console.WriteLine("");

        Console.WriteLine("Press any key to take snapshot 2...");
        Console.Read();

        Console.WriteLine("Taking Snapshot 2...");
        RegistryHive snapshot_2 = regshot.TakeSnapshot(RegistryHiveType.HkeyCurrentUser);
        Console.WriteLine("Snapshot 2 taken");
        Console.WriteLine("");

        var keysDiff = regshot.CompareSnapshots(snapshot_1, snapshot_2);

        PrintRegDiff(keysDiff);
    }

    static void StringsRun(Strings opts)
    {
        var file = new WinFile(opts.File);
        if (!file.Load())
        {
            Console.WriteLine("Failed to load file");
            return;
        }

        StringAnalyser strings = new StringAnalyser(file);
        strings.GenerateStrings();
        var categoriseStrings = strings.GetStrings(new StringFilter(opts.Min, opts.Max, opts.Search));

        foreach (var categoryName in categoriseStrings.Keys)
        {
            Console.WriteLine(categoryName);
            foreach (var stringValue in categoriseStrings[categoryName])
            {
                Console.WriteLine($"    {stringValue}");
            }
        }
    }

    static void VirusTotalRun(VirusTotal opts)
    {
        var virusTotal = new VirusTotalAPI();
        Result? result = virusTotal.GetDetails(opts.ApiKey, opts.Hash);
        if (result == null)
        {
            Console.WriteLine("Failed to get details");
            return;
        }

        PrintVirusTotal(result);
    }

    static void DNSReqCaptureRun(DNSReqCapture opts)
    {
        // Make sure we revert dns if we force quit
        // Or not we will nuke our com's internet
        Console.CancelKeyPress += (sender, eventArgs) => {
            SetDNS.UnsetDNS();
        };

        SetDNS.SettingDNS("127.0.0.1");

        Console.WriteLine("Server Created");
        Server server = new Server();
        server.start();

        try
        {
            while (true)
            {
                server.recv();
                Thread.Sleep(1000);
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            SetDNS.UnsetDNS();
        }

        SetDNS.UnsetDNS();
    }
}
