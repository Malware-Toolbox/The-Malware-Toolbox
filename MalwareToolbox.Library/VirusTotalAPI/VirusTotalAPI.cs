using Newtonsoft.Json;

namespace MalwareToolbox.Library.VirusTotalAPI;

public class VirusTotalAPI
{
    private const string URL = "https://www.virustotal.com/api/v3/files/";
    private readonly HttpClient _client;

    public VirusTotalAPI()
    {
        _client = new HttpClient();
    }

    /// <summary>
    /// Get the report of a file
    /// </summary>
    /// <param name="key">Virus total api key</param>
    /// <param name="hash">Hash of tagert file to get data</param>
    /// <returns>data from Virus total api</returns>
    public Result? GetDetails(string key, string hash)
    {
        _client.BaseAddress = new Uri(URL);
        _client.DefaultRequestHeaders.Add("x-apikey", key);
        HttpResponseMessage response = _client.GetAsync(hash).Result;

        if (!response.IsSuccessStatusCode) return null; //TODO Better error handling
        string result = response.Content.ReadAsStringAsync().Result;
        return JsonConvert.DeserializeObject<Result>(result);
    }

    public async Task<Result?> GetDetailsAsync(string key, string hash)
    {
        _client.BaseAddress = new Uri(URL);
        _client.DefaultRequestHeaders.Add("x-apikey", key);
        HttpResponseMessage response = await _client.GetAsync(hash);

        if (!response.IsSuccessStatusCode) return null; //TODO Better error handling
        string result = await response.Content.ReadAsStringAsync();
        return JsonConvert.DeserializeObject<Result>(result);
    }
}
