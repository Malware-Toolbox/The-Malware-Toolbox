#pragma once
#include "phnt_windows.h"
#include "Utils.h"

using namespace System;
using namespace Collections::Generic;

namespace MalwareToolbox {
	namespace LibraryC {
		namespace RegShot
		{
			ref struct RegistryKey;

			public ref struct RegistryKeyMeta
			{
				DWORD SubKeysCount;
				DWORD MaxSubKeyNameSize;
				DWORD MaxClassSize;
				DWORD ValuesCount;
				DWORD MaxValueNameSize;
				DWORD MaxValueDataSize;
				DWORD SecurityDescriptorSize;
			};

			public ref struct RegistryValue
			{
				~RegistryValue();

				RegistryKey^ Key;
				String^ Name;
				DWORD Type;
				Object^ Data;

				void ParseData(DWORD type, LPBYTE data, DWORD data_size);
				String^ ToString() override;
				bool Equals(Object^ o) override;
			};

			public ref struct RegistryKey
			{
				~RegistryKey();

				RegistryKey^ ParentKey;
				String^ Name;
				String^ FullPath;
				RegistryKeyMeta^ Meta;
				Dictionary<String^, RegistryKey^>^ SubKeys;
				Dictionary<String^, RegistryValue^>^ Values;
			};

			public enum class DiffType
			{
				None,
				Deleted,
				Added,
				Modified,
			};

			public ref struct RegistryValueDiff
			{
				RegistryValueDiff(DiffType type, RegistryValue^ old) : Type(type), Old(old) { };
				RegistryValueDiff(DiffType type, RegistryValue^ old, RegistryValue^ neww) : Type(type), Old(old), New(neww) { };

				DiffType Type;
				RegistryValue^ Old;
				RegistryValue^ New;

				property String^ Name { String^ get(); }
			};

			public ref struct RegistryKeyDiff
			{
				RegistryKeyDiff(DiffType type, RegistryKey^ key): Type(type), Key(key) { };
				RegistryKeyDiff(DiffType type, RegistryKey^ key, List<RegistryValueDiff^>^ valuesDiff) : Type(type), Key(key), ValuesDiff(valuesDiff) { };

				DiffType Type;
				RegistryKey^ Key;
				List<RegistryValueDiff^>^ ValuesDiff;
			};

			public ref class RegShot
			{
			public:
				RegistryKey^ TakeSnapshot();
				List<RegistryKeyDiff^>^ CompareSnapshots(RegistryKey^ first, RegistryKey^ second);

			private:
				void GenerateRegData(HKEY parent_key, LPWSTR key_name, RegistryKey^ reg_key);
				void CompareRegSnapshots(RegistryKey^ first, RegistryKey^ second, List<RegistryKeyDiff^>^ diff);
			};
		}
	}
}
