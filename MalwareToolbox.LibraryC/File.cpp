#include "pch.h"
#include "Utils.h"

#include <cstdio>
#include <phnt_windows.h>
#include <phnt.h>

using namespace System;
using namespace Collections::Generic;
using namespace Runtime::InteropServices;
using namespace MalwareToolbox::LibraryC::Utils;

File::File(String^ filePath)
	: m_file_path(filePath), m_loaded(false)
{
}

File::~File()
{
	Unload();
}

bool File::Load()
{
	if (m_loaded) return true;

	const char* file_path_char = Utils::Converters::cpp_string_to_schar(m_file_path);

	const HANDLE file = CreateFileA(
		file_path_char,
		GENERIC_ALL,
		FILE_SHARE_READ,
		NULL,
		OPEN_EXISTING,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);
	if (file == INVALID_HANDLE_VALUE) return false;

	const DWORD file_size = GetFileSize(file, NULL);
	const LPVOID file_data = HeapAlloc(GetProcessHeap(), 0, file_size);

	DWORD bytes_read;
	const bool read_status = ReadFile(file, file_data, file_size, &bytes_read, NULL);
	if (!read_status) return false;

	m_file = file;
	m_file_size = file_size;
	m_file_data = file_data;
	m_loaded = true;
	return true;
}

bool File::Unload()
{
	HeapFree(GetProcessHeap(), 0, m_file_data);
	CloseHandle(m_file);
	m_file = NULL;
	m_file_size = NULL;
	m_file_data = NULL;
	m_loaded = false;
	return true;
}

String^ File::GetPath()
{
	return m_file_path;
}

DWORD File::GetSize()
{
	return m_file_size;
}

BYTE File::GetByte(DWORD64 offset)
{
	return *(BYTE*)((DWORD64)m_file_data + offset);
}

unsigned char* File::GetData()
{
	return static_cast<unsigned char*>(m_file_data);
}

bool File::IsLoaded()
{
	return m_loaded;
}
