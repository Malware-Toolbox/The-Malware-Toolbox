#pragma once
#include "phnt_windows.h"
#include "Utils.h"

using namespace System;
using namespace Collections::Generic;

namespace MalwareToolbox {
	namespace LibraryC {
		namespace Dynamic
		{
			ref struct RegistryValuesDiff;
			ref struct RegistryKey;

			public ref struct RegistryKeyMeta
			{
				DWORD SubKeysCount;
				DWORD MaxSubKeyNameSize;
				DWORD MaxClassSize;
				DWORD ValuesCount;
				DWORD MaxValueNameSize;
				DWORD MaxValueDataSize;
				DWORD SecurityDescriptorSize;
			};

			public ref struct RegistryValue
			{
				RegistryKey^ Key;
				String^ Name;
				DWORD Type;
				Object^ Data;

				void ParseData(DWORD type, LPBYTE data, DWORD data_size);
				String^ ToString() override;
				bool Equals(Object^ o) override;
			};

			public ref struct RegistryKey
			{
				RegistryKey^ ParentKey;
				String^ Name;
				String^ FullPath;
				RegistryKeyMeta^ Meta;
				Dictionary<String^, RegistryKey^>^ SubKeys;
				Dictionary<String^, RegistryValue^>^ Values;
			};

			public ref struct RegistryKeysDiff
			{
				RegistryKeysDiff();

				List<RegistryKey^>^ RegistryKeyAdded;
				List<RegistryKey^>^ RegistryKeyRemoved;
				Dictionary<RegistryKey^, RegistryValuesDiff^>^ RegistryKeyModified;
			};

			public ref struct RegistryValuesDiff
			{
				RegistryValuesDiff();

				List<RegistryValue^>^ RegistryValueAdded;
				List<RegistryValue^>^ RegistryValueRemoved;
				List<Utils::Modified<RegistryValue^>^>^ RegistryValueModified;
			};

			public ref class RegShot
			{
			public:
				RegistryKey^ TakeSnapshot();
				RegistryKeysDiff^ CompareSnapshots(RegistryKey^ first, RegistryKey^ second);

			private:
				void GenerateRegData(HKEY parent_key, LPWSTR key_name, RegistryKey^ reg_key);
				void CompareRegSnapshots(RegistryKey^ first, RegistryKey^ second, RegistryKeysDiff^ diff);
			};
		}
	}
}
