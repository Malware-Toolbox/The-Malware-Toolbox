using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Windows.Storage;
using MalwareToolbox.LibraryC.Utils;

namespace MalwareToolbox.DesktopApp.Core
{
    public class WinFileManager
    {
        public event EventHandler<WinFileOpenedEventArgs>? WinFileOpened;
        public event EventHandler<WinFileClosingEventArgs>? WinFileClosing;
        public event EventHandler<WinFileClosedEventArgs>? WinFileClosed;

        public WinFile? WinFile { get; private set; }

        public bool OpenFile(StorageFile file)
        {
            return OpenFile(file.Path);
        }

        public bool OpenFile(String filePath)
        {
            if (WinFile != null && !CloseFile()) return false;

            WinFile = new WinFile(filePath);
            if (!WinFile.Load()) return false;

            WinFileOpened?.Invoke(this, new WinFileOpenedEventArgs(filePath, WinFile));
            return true;
        }

        public bool CloseFile()
        {
            if (WinFile == null) return true;

            WinFileClosing?.Invoke(this, new WinFileClosingEventArgs(WinFile.Path, WinFile));
            
            if (!WinFile.Unload()) return false;
            WinFile.Dispose();
            WinFile = null;

            WinFileClosed?.Invoke(this, new WinFileClosedEventArgs());
            return true;
        }

        public bool IsFileOpened()
        {
            return WinFile is { Loaded: true };
        }
    }
}
