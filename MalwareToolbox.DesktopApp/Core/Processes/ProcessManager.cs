using MalwareToolbox.LibraryC.ProcessAnalysis;
using System;
using System.Threading;

namespace MalwareToolbox.DesktopApp.Core.Processes;

public class ProcessManager
{
    private Timer _processTimer;

    public ProcessProvider ProcessProvider { get; }

    public event EventHandler<ProcessUpdateEventArgs> ProcessUpdate;

    public ProcessManager()
    {
        ProcessProvider = new ProcessProvider(() => new ObservableProcess(), () => new ObservableThread());
    }

    public IProcess GetProcessById(uint processId)
    {
        return ProcessProvider.GetProcess(processId);
    }

    public void StartProcessCapture()
    {
        if (_processTimer != null) return;
        _processTimer = new Timer(FetchProcesses, null, 0, 1000); //TODO customizable rate
    }

    public void StopProcessCapture()
    {
        if (_processTimer == null) return;
        _processTimer.Dispose();
        _processTimer = null;
    }

    private void FetchProcesses(object state)
    {
        var processes = ProcessProvider.QueryProcesses();
        ProcessUpdate?.Invoke(this, new ProcessUpdateEventArgs(processes, true));
    }
}
