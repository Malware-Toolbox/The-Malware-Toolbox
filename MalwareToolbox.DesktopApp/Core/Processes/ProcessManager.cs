using MalwareToolbox.LibraryC.ProcessAnalysis;
using System;
using System.Threading;

namespace MalwareToolbox.DesktopApp.Core.Processes;

public class ProcessManager
{
    private readonly ProcessProvider _processProvider;

    private Timer _processTimer;

    public event EventHandler<ProcessUpdateEventArgs> ProcessUpdate;

    public ProcessManager()
    {
        _processProvider = new ProcessProvider();
    }

    public void StartProcessCapture()
    {
        if (_processTimer != null)
        {
            _processTimer.Dispose();
            _processTimer = null;
        }

        _processTimer = new Timer(FetchProcesses, null, 0, 1000);
    }

    public void StopProcessCapture()
    {
        _processTimer.Dispose();
        _processTimer = null;
    }

    private void FetchProcesses(object state)
    {
       var processes = _processProvider.GetProcesses();
        ProcessUpdate?.Invoke(this, new ProcessUpdateEventArgs(processes));
    }
}
