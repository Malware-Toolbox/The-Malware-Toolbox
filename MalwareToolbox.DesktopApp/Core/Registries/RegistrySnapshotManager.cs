using System;
using System.Collections.Generic;
using System.Threading.Tasks;
using MalwareToolbox.LibraryC.RegShot;

namespace MalwareToolbox.DesktopApp.Core.Registries;

public class RegistrySnapshotManager
{
    private readonly RegShot _regshot;
    private readonly List<RegistrySnapshot> _snapshots;

    public event EventHandler SnapshotCreated;

    public ViewTarget Target { get; set; }

    public RegistrySnapshotManager()
    {
        _regshot = new RegShot();
        _snapshots = new List<RegistrySnapshot>();
    }

    public async Task<RegistrySnapshot> TakeSnapshotAsync(RegistryHiveType hiveType)
    {
        var snapshot = await Task.Run(() => _regshot.TakeSnapshot(hiveType));
        AddSnapshot(snapshot);
        SnapshotCreated?.Invoke(this, new SnapshotCreatedEventArgs(snapshot));
        return snapshot;
    }

    public bool AddSnapshot(RegistrySnapshot snapshot)
    {
        if (GetSnapshotByName(snapshot.Name) != null)
        {
            snapshot.Name = $"{snapshot.Name} ({_regshot.NextCount()})";
        }
        _snapshots.Add(snapshot);
        return true;
    }

    public async Task<List<RegistryKeyDiff>> CompareSnapshots(CompareTarget compareTarget)
    {
        return await CompareSnapshots(GetSnapshotByName(compareTarget.SnapshotName), GetSnapshotByName(compareTarget.OtherSnapshotName));
    }

    public async Task<List<RegistryKeyDiff>> CompareSnapshots(RegistrySnapshot snpashot1, RegistrySnapshot snpashot2)
    {
        return await Task.Run(() => _regshot.CompareSnapshots(snpashot1, snpashot2));
    }

    public RegistrySnapshot GetSnapshotByName(string name)
    {
        return _snapshots.Find(s => s.Name.Equals(name));
    }

    public bool DeleteSnapshot(string name)
    {
        return DeleteSnapshot(GetSnapshotByName(name));
    }

    public bool DeleteSnapshot(RegistrySnapshot snapshot)
    {
        return snapshot != null && _snapshots.Remove(snapshot);
    }
}
