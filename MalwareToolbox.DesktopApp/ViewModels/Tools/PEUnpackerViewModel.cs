using System;
using System.Collections.ObjectModel;
using System.IO;
using System.Threading.Tasks;
using MalwareToolbox.DesktopApp.Core.WindowFiles;
using MalwareToolbox.LibraryC.Executables;
using MalwareToolbox.LibraryC.Unpackers;

namespace MalwareToolbox.DesktopApp.ViewModels.Tools;

public class PEUnpackerViewModel : ToolboxViewModel
{
    private PackerDatabase _packerDb;
    private bool _initialised;

    private bool _loading;

    public bool Loading
    {
        get => _loading;
        set => SetProperty(ref _loading, value);
    }

    public ObservableCollection<string> SignaturesCollection { get; }

    public PEUnpackerViewModel()
    {
        SignaturesCollection = new ObservableCollection<string>();
        FileManager.WinFileClosed += WinFileManager_WinFileClosed;
    }

    public async void InitPeid()
    {
        if (_packerDb == null)
        {
            var dbPath = App.Instance.IsRunningAsUwp
                ? (await Windows.ApplicationModel.Package.Current.InstalledLocation.GetFileAsync(@"Assets\userdb.txt")).Path
                : Path.Join(Directory.GetCurrentDirectory(), @"Assets\userdb.txt");
            
            _packerDb = new PackerDatabase(dbPath);
            _packerDb.Load();
        }

        if (!_initialised)
        {
            _initialised = true;
            await DetectPacker();
        }
    }

    public async Task DetectPacker()
    {
        if (_packerDb == null || !_packerDb.Loaded) return;

        Loading = true;
        SignaturesCollection.Clear();
        
        var signatures = await Task.Run(() =>
        {
            var pe = new PE(FileManager.WinFile);
            if (!pe.LoadHeaders())
            {
                Console.WriteLine("Failed to load PE");
                return null;
            }
            var result = _packerDb.ScanPE(pe, ScanMode.EpOnly);
            pe.Dispose();

            return result;
        });

        if (signatures != null)
        {
            foreach (var signature in signatures)
            {
                SignaturesCollection.Add(signature.Tool);
            }
        }

        Loading = false;
    }

    private void WinFileManager_WinFileClosed(object sender, WinFileClosedEventArgs e)
    {
        _initialised = false;
        SignaturesCollection.Clear();
    }    
}
