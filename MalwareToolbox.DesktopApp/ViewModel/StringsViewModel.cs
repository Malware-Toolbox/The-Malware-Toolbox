using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Diagnostics.CodeAnalysis;
using System.Linq;
using System.Runtime.CompilerServices;
using System.Text;
using System.Threading.Tasks;
using CommunityToolkit.Mvvm.ComponentModel;
using MalwareToolbox.DesktopApp.Core;
using MalwareToolbox.DesktopApp.Core.Utils;
using MalwareToolbox.LibraryC.Strings;
using Microsoft.UI.Xaml;

namespace MalwareToolbox.DesktopApp.ViewModel;

public class StringsViewModel : ObservableRecipient
{
    private readonly WinFileManager _fileManager;
    private StringAnalyser? _stringAnalyser;

    //todo save defaults
    private bool _loading;
    private bool _filterChanged;
    private ObservableCollection<GroupedList> _stringsCollection;
    private double _minLength = 10;
    private double _maxLength = 100;
    private string _search;
    private StringsDuplicateMode _duplicateMode = StringsDuplicateMode.Keep;

    public bool Loading
    {
        get => _loading;
        set => SetProperty(ref _loading, value);
    }

    public ObservableCollection<GroupedList> StringsCollection
    {
        get => _stringsCollection;
        set => SetProperty(ref _stringsCollection, value);
    }

    public double MinLength
    {
        get => _minLength;
        set => SetFilterProperty(ref _minLength, value);
    }
    
    public double MaxLength
    {
        get => _maxLength;
        set => SetFilterProperty(ref _maxLength, value);
    }

    public string Search
    {
        get => _search;
        set => SetFilterProperty(ref _search, value);
    }

    public StringsDuplicateMode DuplicateMode
    {
        get => _duplicateMode;
        set => SetFilterProperty(ref _duplicateMode, value);
    }

    public StringsViewModel()
    {
        _fileManager = (Application.Current as App)!.MainWindow.FileManager;
        _fileManager.WinFileClosed += WinFileManager_WinFileClosed;
    }

    public void InitStrings()
    {
        if (_stringAnalyser == null && _fileManager.IsFileOpened())
        {
            _stringAnalyser = new StringAnalyser(_fileManager.WinFile);
            _filterChanged = true;
            LoadStringsAsync();
        }
        else
        {
            //TODO Dialog file not loaded
        }
    }

    public async void LoadStringsAsync()
    {
        if (!_filterChanged) return;

        Loading = true;
        StringsCollection = await Task.Run(() =>
        {
            var observableCollection = new ObservableCollection<GroupedList>();
            foreach (var keyValuePair in _stringAnalyser.GetStrings(new StringFilter((int)MinLength, (int)MaxLength, Search)))
            {
                observableCollection.Add(new GroupedList(keyValuePair.Value) { Key = keyValuePair.Key });
            }
            return observableCollection;
        });
        Loading = false;
        _filterChanged = false;
    }

    private bool SetFilterProperty<T>([NotNullIfNotNull("newValue")] ref T field, T newValue, [CallerMemberName] string? propertyName = null)
    {
        _filterChanged = true;
        return SetProperty(ref field, newValue, propertyName);
    }

    private void WinFileManager_WinFileClosed(object sender, WinFileClosedEventArgs e)
    {
        _stringAnalyser = null;
        StringsCollection = null;
    }
}
