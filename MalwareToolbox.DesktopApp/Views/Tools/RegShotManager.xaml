<Page
    x:Class="MalwareToolbox.DesktopApp.Views.Tools.RegShotManager"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:regShot="using:MalwareToolbox.LibraryC.RegShot"
    xmlns:items="using:MalwareToolbox.DesktopApp.UI.Items"
    xmlns:converters="using:CommunityToolkit.WinUI.UI.Converters"
    mc:Ignorable="d"
    NavigationCacheMode="Enabled">

    <Page.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter" />

        <DataTemplate x:Key="RegistrySnapshotItemTemplate" x:DataType="items:RegistrySnapshotItem">
            <ListViewItem Name="{x:Bind Name, Mode=OneWay}"
                          Background="{ThemeResource ButtonBackground}"
                          IsSelected="{x:Bind IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          IsEnabled="{x:Bind IsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          DoubleTapped="SnapshotViewItem_DoubleTapped">
                <Grid Padding="0,10,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Style="{ThemeResource BaseTextBlockStyle}"
                               Text="{x:Bind Name}" />

                    <TextBlock Grid.Row="1"
                               Grid.Column="0"
                               Margin="0,8,0,0"
                               Text="{x:Bind Type.Name}" />

                    <TextBlock Grid.Row="0"
                               Grid.Column="1"
                               Grid.RowSpan="2"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"
                               Text="{x:Bind CaptureTime}" />

                    <Button Grid.Row="0"
                            Grid.Column="2"
                            Grid.RowSpan="2"
                            Name="SnapshotMoreOption"
                            Background="Transparent"
                            BorderBrush="Transparent"
                            Visibility="{x:Bind IsSelected, Converter={StaticResource BoolToVisibilityConverter}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                            ToolTipService.ToolTip="More options">
                        <FontIcon Glyph="&#xE10C;" FontFamily="Segoe MDL2 Assets" Foreground="{ThemeResource SystemControlBackgroundBaseMediumBrush}" />

                        <Button.Flyout>
                            <MenuFlyout>
                                <MenuFlyoutItem Text="Delete" Icon="Delete" Tag="{x:Bind Name}" Click="DeleteFlyoutItem_OnClick" />
                                <MenuFlyoutItem Text="Export" Icon="Share" Tag="{x:Bind Name}" Click="ExportFlyoutItem_OnClick"  />
                                <MenuFlyoutItem Text="View" Icon="View" Tag="{x:Bind Name}" Click="ViewFlyoutItem_OnClick" />
                            </MenuFlyout>
                        </Button.Flyout>
                    </Button>
                </Grid>

                <ListViewItem.ContextFlyout>
                    <MenuFlyout>
                        <MenuFlyoutItem Text="Delete" Icon="Delete" Tag="{x:Bind Name}" Click="DeleteFlyoutItem_OnClick" />
                        <MenuFlyoutItem Text="Export" Icon="Share" Tag="{x:Bind Name}" Click="ExportFlyoutItem_OnClick"  />
                        <MenuFlyoutItem Text="View" Icon="View" Tag="{x:Bind Name}" Click="ViewFlyoutItem_OnClick" />
                    </MenuFlyout>
                </ListViewItem.ContextFlyout>
            </ListViewItem>
        </DataTemplate>

        <DataTemplate x:Key="RegistrySnapshotCompareItemTemplate" x:DataType="items:RegistrySnapshotItem">
            <ListViewItem Background="{ThemeResource ButtonBackground}"
                          IsSelected="{x:Bind IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          IsEnabled="{x:Bind IsEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <Grid Padding="0,10,0,10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock Style="{ThemeResource BaseTextBlockStyle}"
                               Text="{x:Bind Name}" />

                    <TextBlock Grid.Row="1"
                               Grid.Column="0"
                               Margin="0,8,0,0"
                               Text="{x:Bind Type.Name}" />

                    <TextBlock Grid.Row="0"
                               Grid.Column="1"
                               Grid.RowSpan="2"
                               VerticalAlignment="Center"
                               Margin="0,0,8,0"
                               Text="{x:Bind CaptureTime}" />
                </Grid>
            </ListViewItem>
        </DataTemplate>

        <TeachingTip x:Name="SnapshotButtonTeachingTip"
                     Target="{x:Bind SnapshotButton}"
                     Title="Take a Snapshot"
                     Subtitle="You can take a snapshot of your computer's current registry data." />

        <TeachingTip x:Name="SnapshotLoadTeachingTip"
                     Target="{x:Bind SnapshotButton}"
                     Title="Take a Snapshot"
                     Subtitle="Wait for it to load. This may take a few seconds..." />
        
        <TeachingTip x:Name="SnapshotItemTeachingTip"
                     Title="Snapshot"
                     Subtitle="This is the snapshot you have taken, click on it to select."
                     PreferredPlacement="Bottom" />

        <TeachingTip x:Name="SnapshotItemMoreOptionTeachingTip"
                     Title="More Options"
                     Subtitle="Click on this to view more actions. You can view, export or delete this snapshot."
                     PreferredPlacement="Bottom" />

        <TeachingTip x:Name="AnotherSnapshotTeachingTip"
                     Target="{x:Bind SnapshotButton}"
                     Title="Another Snapshot"
                     Subtitle="Take another snapshot for us to compare against." />

        <TeachingTip x:Name="CompareItemTeachingTip"
                     Title="Select Compare"
                     Subtitle="Select the new snapshot as the compare target."
                     PreferredPlacement="Bottom" />

        <TeachingTip x:Name="CompareButtonTeachingTip"
                     Target="{x:Bind CompareButton}"
                     Title="Compare Snapshots"
                     Subtitle="Click here to compare between the two snapshots." />

        <TeachingTip x:Name="ImportButtonTeachingTip"
                     Target="{x:Bind ImportButton}"
                     Title="Importing Snapshot"
                     Subtitle="You can import an existing snapshot from a registry file.">
            <HyperlinkButton NavigateUri="https://docs.fileformat.com/executable/reg/" Content="learn more" />
        </TeachingTip>
    </Page.Resources>

    <Grid Padding="{ThemeResource PageGridMargin}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Grid VerticalAlignment="Top" Margin="0,0,0,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal">
                <ComboBox DisplayMemberPath="Name"
                          Margin="0,0,8,0"
                          ItemsSource="{x:Bind regShot:RegistryHiveType.GetAllTypes()}"
                          SelectedItem="{x:Bind ViewModel.HiveType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                <Button x:Name="SnapshotButton"
                        Margin="0,0,8,0"
                        Style="{ThemeResource AccentButtonStyle}"
                        IsEnabled="{x:Bind ViewModel.SnapshotButtonEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        Click="{x:Bind ViewModel.TakeSnapshot}">
                    <StackPanel Orientation="Horizontal">
                        <FontIcon Glyph="&#xE15A;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" />
                        <TextBlock Text="Take Snapshot"/>
                        <ProgressRing MaxHeight="16"
                                  MaxWidth="16"
                                  IsActive="{x:Bind ViewModel.SnapshotLoading, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Visibility="{x:Bind ViewModel.SnapshotLoading, Converter={StaticResource BoolToVisibilityConverter}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Margin="8,0,0,0" />
                    </StackPanel>
                </Button>
            </StackPanel>

            <Button Grid.Column="1"
                    x:Name="ImportButton"
                    HorizontalAlignment="Right"
                    IsEnabled="{x:Bind ViewModel.ImportButtonEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    Click="{x:Bind ViewModel.ImportSnapshot}"
                    ToolTipService.ToolTip="Import a registry file">
                <StackPanel Orientation="Horizontal">
                    <FontIcon Glyph="&#xE118;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" />
                    <TextBlock Text="Import" />
                    <ProgressRing MaxHeight="16"
                                  MaxWidth="16"
                                  IsActive="{x:Bind ViewModel.ImportLoading, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Visibility="{x:Bind ViewModel.ImportLoading, Converter={StaticResource BoolToVisibilityConverter}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                  Margin="8,0,0,0" />
                </StackPanel>
            </Button>
        </Grid>

        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <ListView x:Name="SnapshotsListView"
                      ItemTemplate="{StaticResource RegistrySnapshotItemTemplate}"
                      ItemsSource="{x:Bind ViewModel.DisplaySnapshots}"
                      SelectedItem="{x:Bind ViewModel.DisplaySnapshotsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

            <Border Grid.Column="1"
                    Background="{ThemeResource ButtonBackground}"
                    Padding="4,0,4,0"
                    CornerRadius="4">
                <FontIcon  Glyph="&#xE13C;" FontFamily="Segoe MDL2 Assets" />
            </Border>

            <ListView x:Name="CompareListView"
                      Grid.Column="2"
                      ItemTemplate="{StaticResource RegistrySnapshotCompareItemTemplate}"
                      ItemsSource="{x:Bind ViewModel.DisplayCompare}"
                      SelectedItem="{x:Bind ViewModel.DisplayCompareSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

        </Grid>

        <Button x:Name="CompareButton"
                Grid.Row="2"
                Margin="0,8,0,16"
                HorizontalAlignment="Stretch"
                IsEnabled="{x:Bind ViewModel.CompareButtonEnabled, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                Click="{x:Bind ViewModel.CompareSnapshot}">
            <StackPanel Orientation="Horizontal">
                <FontIcon Glyph="&#xE13C;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" />
                <TextBlock Text="Compare" Style="{ThemeResource BaseTextBlockStyle}" />
            </StackPanel>
        </Button>

    </Grid>
</Page>
